<!DOCTYPE html>
<html>
    <head>
        <title>ESION</title>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
        <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    </head>
    <style>
        body{min-width:1000px;font-family:'Times New Roman',Times,serif;overflow-x: hidden;}
        input{margin-bottom:3px;margin-top:0px;}
        label{margin-left:3px;margin-right:3px;font-size:12pt;}
        .clear{clear:both;}
        .row{margin-right:-5px;margin-left:-5px;}
        .row:before,.row:after{display:table;content:' ';}
        .row:after {clear: both;}
        .col-xs-1,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-10,.col-xs-11,.col-xs-12{position:relative;min-height:1px;padding-bottom:5px;padding-top:5px;padding-right:10px;padding-left:10px;float:left;}
        .border{border:1px solid rgb(0,200,0);border-radius:3px;}
        .chart,.msg{width:95%;margin:3px 0;padding:10px;font-size:14px;line-height:16px;text-align:left;color:#333333;border-radius:3px;}
        .msg,.time{display:block;float:right;font-size:10px;line-height:17px;}
        .msg-left{float:left;background:#e8e8e8;}
        .msg-right{float:right;background:#c5eee1;}
    </style>
    <body>
        <div class='col-xs-12'>
            <div id='esion_container' class='border col-xs-12'>
                <div class='row col-xs-12'>
                    <div id='esion_label' class='col-xs-10'>
                        <h2>ESION</h2>
                    </div>
                    <div id='esion_version' class='col-xs-2' style='text-align: right;'>
                        <h3>V 1.0</h3>
                    </div>
                </div>
                <div id='settings_container' class='col-xs-7'>
                    <div class='border col-xs-12'>
                        <div class='col-xs-12'>
                            <div id='wifi_container'>
                                <div class='row col-xs-12'>
                                    <div class='row col-xs-10'>
                                        <input id='wifi_ssid' class='col-xs-12' type='text' placeholder='wifi SSID'>
                                    </div>
                                    <div class='row col-xs-2'>
                                        <button id='save_wifi_ssid' class='btn btn-success col-xs-12'>SET</button>
                                    </div>
                                </div>
                                <div class='row col-xs-12'>
                                    <div class='row col-xs-10'>
                                        <input id='wifi_pswd' class='col-xs-12' type='text' placeholder='wifi PSWD'>
                                    </div>
                                    <div class='row col-xs-2'>
                                        <button id='save_wifi_pswd' class='btn btn-success col-xs-12'>SET</button>
                                    </div>
                                </div>
                            </div>
                            <div id='service_container'>
                                <div class='row col-xs-12'>
                                    <div class='row col-xs-10'>
                                        <input id='service_url' class='col-xs-12' type='text' placeholder='Service URL'>
                                    </div>
                                    <div class='row col-xs-2'>
                                        <button id='save_service_url' class='btn btn-success col-xs-12'>SET</button>
                                    </div>
                                </div>
                            </div>
                            <div class='clear'></div>
                        </div>
                        <div class='col-xs-12'>
                            <div id='sensor_1' class='row col-xs-12'>
                                <label>cencor 1: </label>
                                <label id='sensor_1_label'>0</label>
                            </div>
                            <div id='sensor_2' class='row col-xs-12'>
                                <label>cencor 2: </label>
                                <label id='sensor_2_label'>0</label>
                            </div>
                            <div class='clear'></div>
                            <div id='time' class='row col-xs-12'>
                                <label>time: </label>
                                <label id='time_label'>00:00:00</label>
                            </div>
                            <div id='battary' class='row col-xs-12'>
                                <label>battary: </label>
                                <label id='battary_label'>3.3 V</label>
                            </div>
                            <div class='clear'></div>
                        </div>
                        <div class='row col-xs-12'>
                            <div class='row col-xs-4'></div>
                            <div class='row col-xs-4'>
                                <button id='reset_page' class='btn btn-primary col-xs-12'>RESET PAGE</button>
                            </div>
                            <div class='row col-xs-4'></div>
                        </div>
                    </div>
                </div>
                <div class='col-xs-5'>
                    <div id='log_container' class='border col-xs-12'>
                        <div id='log_label' style='text-align: center;'>
                            <h3>Logging</h3>
                        </div>
                        <div id='esion_log' style='overflow-y: auto;'>
                            <div id='log' class='chart'></div>
                            <div class='clear'></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        window.is_reset_page = false;
        window.log_lines_max_num = 100;
        function sendSettings() {
            var s = {
                wifi:{
                    ssid:$('#wifi_ssid').val(),
                    pswd:$('#wifi_pswd').val()
                },
                admin:{
                    surl:$('#service_url').val()
                }  
            };
            var xhr = new XMLHttpRequest();
            xhr.open('post', window.location);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.send('json=' + JSON.stringify(s));
        }
        function setScrollLogHeight() {
            var h = $('#settings_container').height() - $('#log_label').height() - 50;
            $('#esion_log').css('max-height', h);
            console.log('# ' + h);
        }
        function setLogHeight() {
            var h = $('#settings_container').height();
            $('#log_container').css('height', h);
            console.log('# ' + h);
        }
        function updateLog() {
            if ($('#log .msg').length > window.log_lines_max_num) {
                $('#log .msg:last').remove();
            }
        }
        function addLeftLog(msg) {
            var tops = {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: 'numeric', minute: 'numeric', second: 'numeric'
            };
            $('#log').prepend('<div class=\'msg msg-left\'>' + msg + '</div>');
            updateLog();
            setScrollLogHeight();
        }
        function addRightLog(msg) {
            var tops = {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: 'numeric', minute: 'numeric', second: 'numeric'
            };
            var t = new Date();
            $('#log').prepend('<div class=\'msg msg-right\'>' + t.toLocaleString('ru-RU', tops) + " | " + msg + '</div>');
            updateLog();
            setScrollLogHeight();
        }
        function changeSetting(id_, prefix_) {
            var v = $(id_).val();
            if (v) {
                $(id_).attr('placeholder', v);
                sendSettings();
                $(id_).val('');
                addRightLog(prefix_ + ': \'' + v + '\'');
            }
        }
        function handleSettings() {
            $('#save_wifi_ssid').click(function() {
                if ( ! window.is_reset_page) {
                    changeSetting('#wifi_ssid', 'ssid');
                }
            });            
            $('#save_wifi_pswd').click(function() {
                if ( ! window.is_reset_page) {
                    changeSetting('#wifi_pswd', 'pswd');
                }
            });            
            $('#save_service_url').click(function() {
                if ( ! window.is_reset_page) {
                    changeSetting('#service_url', 'service url');
                }
            });            
            $('#reset_page').click(function() {
                window.is_reset_page = true;
                setTimeout(function() { 
                    location.reload();
                }, 3000);
            });            
        }
        function setStatus(json_) {
            if (typeof json_.time !== 'undefined') {
                $('#time_label').html(json_.status.time);
            }
            if (typeof json_.sensor1 !== 'undefined') {
                $('#sensor_1_label').html(json_.status.sensor1);
            }
            if (typeof json_.sensor2 !== 'undefined') {
                $('#sensor_2_label').html(json_.status.sensor2);
            }
            if (typeof json_.battary !== 'undefined') {
                $('#battary_label').html(json_.status.battary + " V");
            }
        }
        function setSettings(json_) {
            if (typeof json_.wifi !== 'undefined') {
                if (typeof json_.wifi.ssid !== 'undefined') {
                    $('#wifi_ssid').attr('placeholder', json_.wifi.ssid);
                }
                if (typeof json_.wifi.pswd !== 'undefined') {
                    $('#wifi_pswd').attr('placeholder', json_.wifi.pswd);
                }
            }
            if (typeof json_.admin !== 'undefined') {
                if (typeof json_.admin.service_url !== 'undefined') {
                    $('#service_url').attr('placeholder', json_.service_url);
                }
            }
        }
        function setUpdateTimeout() {
            var timerId = setInterval(function() {
                $.getJSON(window.location + '/args?update=' + new Date().getTime())
                    .done(function(json_) {
                        if (typeof json_.status !== 'undefined' && 
                            typeof json_.status.updated !== 'undefined' && 
                            json_.status.updated === 1) {
                            setStatus(json_.status);
                            addLeftLog(JSON.stringify(json_));
                        }
                    });
                console.log('Update status');
            }, 3000);
        }
        function getInit() {
            $.getJSON(window.location + '?init=' + new Date().getTime())
                .done(function(json_) {
                    if (typeof json_.status !== 'undefined') {
                        setStatus(json_.status);
                    }
                    if (typeof json_.settings !== 'undefined') {
                        setSettings(json_.settings);
                    }
                    console.log('Init status');
                });
        }
        $(window).resize(function() {
            setLogHeight();
            setScrollLogHeight();
        });
        $(document).ready(function() {
            setLogHeight();
            setScrollLogHeight();
            handleSettings();
            setUpdateTimeout();
        });
    </script>
</html> 